---
import { PREFERENCES_SCHEMA } from "@text-notifications/shared";
---

<section class="user-preferences bg-white/90 backdrop-blur-sm rounded-xl border border-indigo-100 overflow-hidden" x-data="{ open: false }">
    <button 
        type="button"
        class="w-full px-6 py-4 flex items-center justify-between bg-gradient-to-r from-indigo-50/50 to-blue-50/50 hover:from-indigo-100/50 hover:to-blue-100/50 transition-colors cursor-pointer"
        @click="open = !open"
    >
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <div class="text-left">
                <h2 class="text-lg font-semibold text-indigo-900">Personalize Your Experience</h2>
                <p class="text-sm text-slate-600">Customize your notifications and preferences</p>
            </div>
        </div>
        <svg 
            xmlns="http://www.w3.org/2000/svg" 
            class="h-5 w-5 text-indigo-600 transition-transform" 
            :class="{ 'rotate-180': open }"
            fill="none" 
            viewBox="0 0 24 24" 
            stroke="currentColor"
        >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
    </button>
    
    <!-- Preferences grid layout -->
    <div 
        x-show="open" 
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 transform -translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform -translate-y-2"
        class="px-6 py-4 border-t border-indigo-100"
    >
        <!-- Personalization options in a grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <!-- Language preference -->
            <div>
                <label for="preferred_language" class="block text-sm text-slate-600 mb-1">
                    {PREFERENCES_SCHEMA.preferred_language.form_label}
                </label>
                <div class="relative">
                    <select 
                        id="preferred_language"
                        name="preferred_language"
                        aria-label={PREFERENCES_SCHEMA.preferred_language.form_label}
                        aria-describedby="preferred_language-description"
                        class="w-full px-3 py-2 bg-white border border-slate-200 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 text-sm text-slate-800 appearance-none cursor-pointer"
                    >
                        {Object.values(PREFERENCES_SCHEMA.preferred_language.options).map(option => (
                            <option value={option.code}>
                                {option.name}
                            </option>
                        ))}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Unit preference -->
            <div>
                <label for="unit_preference" class="block text-sm text-slate-600 mb-1">
                    {PREFERENCES_SCHEMA.unit_preference.form_label}
                </label>
                <div class="relative">
                    <select 
                        id="unit_preference"
                        name="unit_preference"
                        aria-label={PREFERENCES_SCHEMA.unit_preference.form_label}
                        aria-describedby="unit_preference-description"
                        class="w-full px-3 py-2 bg-white border border-slate-200 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 text-sm text-slate-800 appearance-none cursor-pointer"
                    >
                        {Object.values(PREFERENCES_SCHEMA.unit_preference.options).map(option => (
                            <option value={option.code}>
                                {option.name}
                            </option>
                        ))}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Time Format -->
            <div>
                <label for="time_format" class="block text-sm text-slate-600 mb-1">
                    {PREFERENCES_SCHEMA.time_format.form_label}
                </label>
                <div class="relative">
                    <select 
                        id="time_format"
                        name="time_format"
                        aria-label={PREFERENCES_SCHEMA.time_format.form_label}
                        aria-describedby="time_format-description"
                        class="w-full px-3 py-2 bg-white border border-slate-200 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 text-sm text-slate-800 appearance-none cursor-pointer"
                    >
                        {Object.values(PREFERENCES_SCHEMA.time_format.options).map(option => (
                            <option value={option.code}>
                                {option.name}
                            </option>
                        ))}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Daily Notification Time -->
            <div>
                <label for="daily_notification_time" class="block text-sm text-slate-600 mb-1">
                    {PREFERENCES_SCHEMA.daily_notification_time.form_label}
                </label>
                <div class="relative">
                    <select 
                        id="daily_notification_time"
                        name="daily_notification_time"
                        aria-label={PREFERENCES_SCHEMA.daily_notification_time.form_label}
                        aria-describedby="daily_notification_time-description"
                        class="w-full px-3 py-2 bg-white border border-slate-200 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 text-sm text-slate-800 appearance-none cursor-pointer"
                    >
                        {Object.values(PREFERENCES_SCHEMA.daily_notification_time.options).map(option => (
                            <option value={option.code}>
                                {option.name}
                            </option>
                        ))}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    import { IMPERIAL_COUNTRIES, LANGUAGE_OPTIONS } from "@text-notifications/shared";
    
    function setInitialPreferences() {
        const languageSelect = document.getElementById('preferred_language') as HTMLSelectElement;
        const unitSelect = document.getElementById('unit_preference') as HTMLSelectElement;
        const timeFormatSelect = document.getElementById('time_format') as HTMLSelectElement;

        if (languageSelect && unitSelect && timeFormatSelect) {
            try {
                const [lang, region] = (navigator.language || 'en-US').split('-');
                
                languageSelect.value = lang && Object.keys(LANGUAGE_OPTIONS).includes(lang.toLowerCase())
                    ? lang.toLowerCase()
                    : 'en';
                
                unitSelect.value = region && !IMPERIAL_COUNTRIES.includes(region.toUpperCase() as typeof IMPERIAL_COUNTRIES[number])
                    ? 'metric'
                    : 'imperial';

                // Detect time format preference
                const formatter = new Intl.DateTimeFormat(navigator.language);
                const is12Hour = formatter.resolvedOptions().hour12;
                timeFormatSelect.value = is12Hour ? '12h' : '24h';

            } catch (error) {
                // If anything goes wrong, fall back to default values
                languageSelect.value = 'en';
                unitSelect.value = 'imperial';
                timeFormatSelect.value = '24h';
            }
        }
    }

    // Run initialization immediately
    setInitialPreferences();
</script> 